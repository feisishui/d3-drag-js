(function(){var d;var h=0,p=0,v=0,g=0;var y={};var t=function(t,e){for(var n in e){t[n]=e[n]}return t};var r=function(t){var e={width:300,height:300,data:"",dataList:"",container:"",classedfixed:false,clickevent:"",dblclickevent:"",mouseenterevent:"",mouseleave:"",dragclickevent:""};t=$.extend(true,e,t);this.width=t.width;this.height=t.height;this.data=t.data;this.container=t.container;this.clickevent=t.clickevent;this.dblclickevent=t.dblclickevent;this.mouseenterevent=t.mouseenterevent;this.mouseleave=t.mouseleave;this.classedfixed=t.classedfixed;this.dataList=t.dataList;this.dragclickevent=t.dragclickevent};r.prototype.init=function(){var n=this;if(n.dataList!=""&&n.data==""){n.render(n.dataList.nodes,n.dataList.lines)}else{d3.json(n.data,function(t,e){if(t)throw t;n.data=e;n.render(n.data.nodes,n.data.lines)})}};r.prototype.render=function(t,e){d=t;var n=this;var r=n.width;var a=n.height;var i=d3.select(n.container).append("svg").attr("width",r).attr("height",a).style("pointer-events","all");var s=i.append("g").attr("class","graph");i.call(x(s)).on("dblclick.zoom",null);var o=s.selectAll("g.line").data(e).enter().append("g").attr("class","line");o.append("line").style("stroke",function(t){if(t.status==0){return"#f76e5d"}else{return"#93c62d"}}).style("stroke-width",2);o.each(function(t,e){var n=d3.select(this);if(t.netspeed&&t.status!=0){n.append("text").text(t.netspeed).style("fill","rgb(255,198,22)").style("font-size","11");n.append("rect").attr("fill",function(t){return"#555"}).attr("width",function(t){return 2}).attr("height",function(t){return 2}).append("animate");n.select("rect").append("animate")}else{n.append("image").attr("xlink:href",function(){return y["link-cut"]}).attr("width",16).attr("height",29)}});var c=s.selectAll("g.node").data(t).enter().append("g").attr("class","node").classed("fixed",function(t){t.fixed=n.classedfixed});c.append("image").style("width",function(t){var e=k(t)+"px";return e}).style("height",function(t){var e=k(t)+"px";return e}).attr("xlink:href",function(t){return y[t.type]}).attr("width",function(t){return k(t)}).attr("height",function(t){return k(t)});c.append("text").text(function(t){return t.name}).style("font-size","12px").style("fill","#333").style("word-break","break-all").style("width","150px");c.each(function(t,e){var n=d3.select(this);if(t.status=="0"){n.append("g").attr("class","error-tip").append("image").attr("xlink:href",function(t){return y["error-tip"]}).attr("width",16).attr("height",16)}});var u=d3.layout.force().nodes(t).links(e).size([r,a]).linkDistance(function(t){var e=90;e+=e*Math.random()*.5;return e}).charge(-900).start();var l=c.select("image");if(typeof n.dragclickevent==="function"){l.on("click",function(t){if(p==h&&g==v){n.dragclickevent(this,t)}else{n.dragclickevent(this,false)}});l.on("mousedown",function(t){h=parseInt(t.x);v=parseInt(t.y)});l.on("mouseup",function(t){p=parseInt(t.x);g=parseInt(t.y)})}if(typeof n.dblclickevent==="function"){l.on("dblclick",function(t){n.dblclickevent(this,t)})}if(typeof n.mouseenterevent==="function"){l.on("mouseenter",function(t){d3.select(this).style("cursor","pointer");n.mouseenterevent(this,t)})}if(typeof n.mouseleave==="function"){l.on("mouseleave",function(t){n.mouseleave(this,t)})}if(typeof n.clickevent==="function"){l.on("click",function(t){n.clickevent(this,t)})}var f=u.drag().on("dragstart",m);u.on("tick",function(){o.select("line").attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y});o.select("image").attr("x",function(t){var e=t.source.x,n=t.target.x,r=e-(e-n)/2;return r-8}).attr("y",function(t){var e=t.source.y,n=t.target.y,r=e-(e-n)/2;return r-15});o.select("text").attr("x",function(t){var e=t.source.x,n=t.target.x,r=e-(e-n)/2,a=e-(e-r)/2;return a}).attr("y",function(t){var e=t.source.y,n=t.target.y,r=e-(e-n)/2,a=e-(e-r)/2;a=a-5;return a}).attr("transform",function(t){var e=t.source.x,n=t.target.x,r=t.source.y,a=t.target.y,i=e-(e-n)/2,s=r-(r-a)/2,o=Math.abs(a-r),c=Math.abs(n-e),u=0,l=0,f=e-(e-i)/2,d=r-(r-s)/2;if(e<n){u=(a-r)/Math.sqrt(Math.pow(o,2)+Math.pow(c,2));l=Math.asin(u)*180/Math.PI}else{u=(r-a)/Math.sqrt(Math.pow(o,2)+Math.pow(c,2));l=Math.asin(u)*180/Math.PI;l=l<0?180+l:-(180-l)}return"rotate("+l+","+f+" "+d+")"});o.select("rect").attr("x",function(t){return t.source.x-1}).attr("y",function(t){return t.source.y-1}).selectAll("animate").each(function(t,e){if(e==0){d3.select(this).attr("attributeName",function(t){return"x"}).attr("from",function(t){return t.source.x-1}).attr("to",function(t){return t.target.x})}else{d3.select(this).attr("attributeName",function(t){return"y"}).attr("from",function(t){return t.source.y-1}).attr("to",function(t){return t.target.y})}d3.select(this).attr("attributeType","XML").attr("dur",function(t){return"1.5s"}).attr("repeatCount","indefinite")});c.attr("transform",function(t){var e=d3.select(this).select("image")[0][0],n=parseFloat(e.style.width)/2,r=parseFloat(e.style.height)/2;return"translate("+(t.x-n)+","+(t.y-r)+")"});c.select("text").attr("dy",function(t){var e=this.previousSibling,n=parseFloat(e.style.height),r=parseFloat(this.style.fontSize);return n+1.5*r});c.select(".error-tip").attr("transform",function(t){var e=this.parentNode.firstChild,n=parseFloat(e.style.width);return"translate("+.8*n+",0)"});c.call(f)})};function x(t){return d3.behavior.zoom().scaleExtent([.5,10]).on("zoom",e);function e(){t.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}}function m(t){d3.event.sourceEvent.stopPropagation();d3.select(this).classed("fixed",t.fixed=true)}function k(t){var e=40;switch(t.type){case"0":e=1.5*e;break;case"1":e=1.2*e;break;default:e}return e}var e={};e.init=function(t,e){var n=new r(t);y=e;n.init()};e.getNodesCoordinate=function(t){var e=d;var n=[];if(t&&t.length){for(var r=0;r<e.length;r++){var a={};for(var i=0;i<t.length;i++){var s=t[i];a[s]=e[r][s]||""}n.push(a)}e=n}return e};var n=e;if(typeof module!=="undefined"&&typeof exports==="object"&&define.cmd){module.exports=n}else if(typeof define==="function"&&define.amd){define(function(){return n})}else{window.TpGraph=n}}).call(function(){return this||(typeof window!=="undefined"?window:global)});